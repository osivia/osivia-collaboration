tinymce.create("tinymce.plugins.OsiviaLink",{OsiviaLink:function(b,a){function c(d){var i=$JQry("#"+b.id),h={},k=b.selection,g=b.dom,f,m,l,j;function e(o){var q=k.getContent();if(/</.test(q)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(q)||q.indexOf("href=")==-1)){return false}if(o){var n=o.childNodes,p;if(n.length===0){return false}for(p=n.length-1;p>=0;p--){if(n[p].nodeType!=3){return false}}}return true}f=k.getStart();m=g.getParent(f,"a[href]");j=e(m);h.text=l=m?(m.innerText||m.textContent):k.getContent({format:"text"});h.href=m?g.getAttrib(m,"href"):"";if((value=g.getAttrib(m,"title"))){h.title=value}jQuery.ajax({url:i.data("editor-url"),async:true,cache:true,headers:{"Cache-Control":"max-age=86400, public"},data:{editorId:"link",url:h.href,text:h.text,title:h.title,onlyText:j},dataType:"text",success:function(q,n,r){var o=$JQry("#osivia-modal"),p=JSON.parse(q);o.data("load-url",p.url);o.data("callback-function","tinymceLinkModalCallback");o.data("callback-function-args",new Array(b.id,l,j).join("|"));o.data("title",p.title);o.data("size","large");o.modal("show")}})}b.addButton("osivia_link",{text:"",icon:"link",tooltip:"Insert/edit link",stateSelector:"a[href]",onclick:c,onpostrender:function(d){}})}});tinymce.PluginManager.add("osivia_link",tinymce.plugins.OsiviaLink);function tinymceLinkModalCallback(u){var d=u.split("|"),p=d[0],j=d[1],f=d[2],a=tinymce.EditorManager.get(p),e=$JQry("#osivia-modal"),c=e.find("form"),r=c.find("input[name=done]"),m=r.val(),l=c.find("input[name=url]"),b=l.val(),o=c.find("input[name=text]"),h=o.val(),k=c.find("input[name=title]"),w=k.val(),v=a.selection,q=a.dom,s,g;s=v.getNode();g=q.getParent(s,"a[href]");function n(){var x={href:b,target:null,rel:null,"class":null,title:w?w:null};if(g){a.focus();if(f&&h!=j){if("innerText" in g){g.innerText=h}else{g.textContent=h}}q.setAttribs(g,x);v.select(g);a.undoManager.add()}else{if(f==="true"){a.insertContent(q.createHTML("a",x,q.encode(h)))}else{a.execCommand("mceInsertLink",false,x)}}}function t(){a.undoManager.transact(n)}function i(){a.undoManager.transact(function(){a.execCommand("unlink")})}if(m==="true"){if(b){t()}else{i()}}};